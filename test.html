// product <?php
include 'includes/init.php';
// Add product to cart

?>

<main id="main" class="main" style="background-color: #F7DCB9;">

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Product List</h2>
            <a href="addCart.php" id="viewCartBtn" class="btn btn-light position-relative">
                <i class="bi bi-cart-fill"></i>
                View Cart
                <span id="cartCount"
                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    <?php echo isset($_SESSION['cart_count']) ? $_SESSION['cart_count'] : 0; ?>
                </span>
            </a>

        </div>
    </div>

    <div class="row">
        <!-- Product 1 -->
        <div class="col-md-3">
            <div class="card h-60">
                <img src="assets/img/menu4.png" class="card-img-top" alt="">
                <div class="card-body">
                    <h5 class="card-title">seperso</h5>
                    <p class="card-text">
                        <span class="text-success">price: $20</span>
                    </p>
                    <div class="d-flex align-items-center">
                        <div class="text-warning me-2">&#9733; &#9733; &#9733; &#9733; &#9733;</div>
                        <span>1050</span>
                    </div>
                    <p class="mt-2">Coffee: The Ultimate Fuel for Your Day.</p>
                    <a href="#" class="btn btn-success addToCartBtn" data-product-id="1" data-product-name="seperso"
                        data-price="20">Add to Cart</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-60">
                <img src="assets/img/menu4.png" class="card-img-top" alt="">
                <div class="card-body">
                    <h5 class="card-title">afagadho</h5>
                    <p class="card-text">
                        <span class="text-success">price: $10</span>
                    </p>
                    <div class="d-flex align-items-center">
                        <div class="text-warning me-2">&#9733; &#9733; &#9733; &#9733; &#9733;</div>
                        <span>1050</span>
                    </div>
                    <p class="mt-2">Coffee: The Ultimate Fuel for Your Day.</p>
                    <a href="#" class="btn btn-success addToCartBtn" data-product-id="2" data-product-name="afagadho"
                        data-price="10">Add to Cart</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-60">
                <img src="assets/img/menu4.png" class="card-img-top" alt="">
                <div class="card-body">
                    <h5 class="card-title">turkish</h5>
                    <p class="card-text">
                        <span class="text-success">price: $15</span>
                    </p>
                    <div class="d-flex align-items-center">
                        <div class="text-warning me-2">&#9733; &#9733; &#9733; &#9733; &#9733;</div>
                        <span>1050</span>
                    </div>
                    <p class="mt-2">Coffee: The Ultimate Fuel for Your Day.</p>
                    <a href="#" class="btn btn-success addToCartBtn" data-product-id="3" data-product-name="turkish"
                        data-price="10">Add to Cart</a>
                </div>
            </div>
        </div>
    </div>


</main>

<script>
$(document).ready(function() {
    $('.addToCartBtn').click(function(e) {
        e.preventDefault(); // Prevent default action

        // Get product details from the data attributes
        var productId = $(this).data('product-id');
        var productName = $(this).data('product-name');
        var price = $(this).data('price');

        // Make an AJAX request to add the product to the cart
        $.ajax({
            url: 'addCart.php',
            type: 'POST',
            data: {
                add_to_cart: true,
                product_id: productId,
                product_name: productName,
                price: price
            },
            dataType: 'json',
            success: function(response) {
                // Update the cart count
                $('#cartCount').text(response.cartCount);
                alert('Product added to cart!');
            },
            error: function(xhr, status, error) {
                console.log('Error:', error);
                alert('Error adding product to cart.');
            }
        });
    });
});

</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>


add cart.php


<?php include 'includes/init.php';


// Check if the add_to_cart request is sent via POST
if (isset($_POST['add_to_cart'])) {
    $product_id = $_POST['product_id'];
    $product_name = $_POST['product_name'];
    $price = $_POST['price'];

    // Check if cart session exists
    if (!isset($_SESSION['cart'])) {
        $_SESSION['cart'] = [];
    }

    // Check if the product is already in the cart
    $found = false;
    foreach ($_SESSION['cart'] as &$cart_item) {
        if ($cart_item['product_id'] == $product_id) {
            $cart_item['quantity']++;
            $found = true;
            break;
        }
    }

    // If not found, add the new product to the cart
    if (!$found) {
        $_SESSION['cart'][] = [
            'product_id' => $product_id,
            'product_name' => $product_name,
            'price' => $price,
            'quantity' => 1
        ];
    }

    // Update cart count
    $_SESSION['cart_count'] = count($_SESSION['cart']);

    // Respond with updated cart count in JSON format
    echo json_encode(['cartCount' => $_SESSION['cart_count']]);
    exit();
}


// if (isset($_POST['item_key'])) {
//     $item_key = $_POST['item_key'];
    
//     // Check if the cart exists
//     if (isset($_SESSION['cart'][$item_key])) {
//         // Remove the item from the cart
//         unset($_SESSION['cart'][$item_key]);
        
//         // Optionally, re-index the cart array
//         $_SESSION['cart'] = array_values($_SESSION['cart']);
        
//         // Redirect back to the cart page
//         header("Location: cart.php");
//         exit();
//     }
// }
?>



<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
</head>

<body>
    <main id="main" class="main" style="background-color: #FFEEAD;">
        <div class="btn btn-primary" style="color:black;">
            <a href="product.php">back to product</a>
        </div>

        <div class="container mt-5">
            <h2>Items Added to Cart</h2>
            <div class="row">
                <?php if (isset($_SESSION['cart']) && !empty($_SESSION['cart'])): ?>
                <?php foreach ($_SESSION['cart'] as $key => $cart_item): ?>
                <div class="col-md-4">
                    <div class="card">
                        <h5 class="card-title"><?php echo htmlspecialchars($cart_item['product_name']); ?></h5>
                        <p class="card-text">Price: $<?php echo htmlspecialchars($cart_item['price']); ?></p>
                        <p class="card-text">Quantity: <?php echo htmlspecialchars($cart_item['quantity']); ?></p>
                       
                    </div>
                </div>
                <?php endforeach; ?>
                <?php else: ?>
                <p>Your cart is empty.</p>
                <?php endif; ?>
            </div>
            <div class="total-section d-flex justify-content-end mt-4">
                <div class="text-end">
                    <h4>
                        <?php
                        // Calculate the total price
                        $total = 0;
                        if (isset($_SESSION['cart'])) {
                            foreach ($_SESSION['cart'] as $cart_item) {
                                $total += $cart_item['price'] * $cart_item['quantity'];
                            }
                        }
                        echo "Order Total: $" . number_format($total, 2);
                        ?>
                    </h4>
                    <a href="Checkout.php" class="btn btn-success">Checkout</a>
                </div>
            </div>
        </div>
    </main>
</body>

</html>




<?php
include 'includes/init.php'; // Include your database connection
session_start();

if (isset($_POST['remove_item'])) {
    $product_id = $_POST['remove_item'];
    foreach ($_SESSION['cart'] as $key => $cart_item) {
        if ($cart_item['product_id'] == $product_id) {
            unset($_SESSION['cart'][$key]);
            break;
        }
    }
    header('Location: ' . $_SERVER['PHP_SELF']); // Redirect to the same page
    exit();
}

// Ensure your connection variable is $conn
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Check if the cart session is set
    if (isset($_SESSION['cart']) && !empty($_SESSION['cart'])) {
        // Calculate the total price
        $total = 0;
        foreach ($_SESSION['cart'] as $cart_item) {
            $total += $cart_item['price'] * $cart_item['quantity'];
        }

        // Insert into the orders table
        $stmt = $conn->prepare("INSERT INTO orders (total_amount, order_status, payment_method) VALUES (?, ?, ?)");
        $orderStatus = 'Pending'; // Set a default order status
        $paymentMethod = 'Online Payment'; // Example payment method

        if ($stmt->execute([$total, $orderStatus, $paymentMethod])) {
            // Get the last inserted order ID
            $orderId = $conn->lastInsertId();

            // Insert into the order_items table
            $itemStmt = $conn->prepare("INSERT INTO order_items (order_id, product_id, quantity, price, total) VALUES (?, ?, ?, ?, ?)");
            
            foreach ($_SESSION['cart'] as $cart_item) {
                $itemTotal = $cart_item['price'] * $cart_item['quantity']; // Calculate total for the item
                $itemStmt->execute([$orderId, $cart_item['product_id'], $cart_item['quantity'], $cart_item['price'], $itemTotal]);
            }

            // Clear the cart after successful checkout
            unset($_SESSION['cart']);

            // Redirect to a success page or display a success message
            header('Location: success.php'); // Change to your success page
            exit();
        } else {
            echo "Error: Could not place order.";
        }
    } else {
        echo "Your cart is empty.";
    }
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    .order-card {
        margin: 15px 0;
        border: 1px solid #ddd;
        border-radius: 0.5rem;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .total-section {
        margin-top: 30px;
        padding: 15px;
        border-top: 2px solid #ddd;
    }

    .container {
        width: 500px;
        border: 2px solid #dddfdd;
    }
    </style>
</head>

<body>

    <main id="main" class="main">
        <h2>Order List</h2>
        <div class="row">
            <?php if (isset($_SESSION['cart']) && !empty($_SESSION['cart'])): ?>
            <?php foreach ($_SESSION['cart'] as $cart_item): ?>
            <div class="col-md-3">
                <div class="card h-60">
                    <img src="assets/img/menu4.png" class="card-img-top" alt="">
                    <div class="card-body">
                        <h5 class="card-title">
                            <?php echo isset($cart_item['product_name']) ? htmlspecialchars($cart_item['product_name']) : 'Unknown product'; ?>
                        </h5>
                        <p class="card-text">
                            <span class="text-success">Price:
                                $<?php echo isset($cart_item['price']) ? htmlspecialchars($cart_item['price']) : 'N/A'; ?>
                            </span>
                        </p>
                        <p class="card-text">Quantity:
                            <?php echo isset($cart_item['quantity']) ? htmlspecialchars($cart_item['quantity']) : 'N/A'; ?>
                        </p>
                        <p class="mt-2">Coffee: The Ultimate Fuel for Your Day.</p>
                        <form action="" method="post">
                            <input type="hidden" name="remove_item" value="<?php echo $cart_item['product_id']; ?>">
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </div>
                </div>
            </div>
            <?php endforeach; ?>
            <?php else: ?>
            <p>Your cart is empty.</p>
            <?php endif; ?>

        </div>
        <button type="submit" class="btn btn-primary">Place Order</button>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>